#!/usr/bin/env ruby

require 'thor'
require 'colorize'
require 'open-uri'
require 'simple-rss'
require 'erb'

class RSS < Thor

  desc "latest", "Get latest feed from favorite rss/atom sources"
  def latest
    load_feeds.each do |feed|
      rss = SimpleRSS.parse open feed
      puts "+".red * 160
      puts "+ ".red + rss.channel.title.red
      puts "+".red * 160
      rss.entries.each do |entry|
        puts entry.title.blue.on_red.uncolorize
        puts entry.link.colorize(:light_blue).underline
        puts "-"*160
      end
    end
  end

  desc "print", "Print the feed to an HTML file on the desktop to review later"
  def print
    template = %q{
      <% @feeds.each do |site| %>
        <%= site.channel.title %>
      <% end %>
    }.gsub(/^  /, '')

    latest = ERB.new(template, 0, "%<>")

    @feeds = load_feeds.map { |feed| feed = SimpleRSS.parse open(feed) }

    file = latest.result

    puts file
  end

  private
    def load_feeds
      File.readlines(Dir.pwd + '/data.symlink/feeds.txt')
    end
end

RSS.start
